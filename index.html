<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>å®‰å®‰çš„ä¸¾ç”»æ¿è¡¨æƒ…åŒ…ç”Ÿæˆå™¨</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&family=ZCOOL+KuaiLe&family=Noto+Color+Emoji&display=swap" rel="stylesheet">
  <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        font-family: 'Noto Sans SC', 'Noto Color Emoji', sans-serif;
        margin: 0;
        padding: 45px 15px 15px 15px;
        min-height: 100vh;
        background-color: #1a1a1a;
        background-image: url('mdh.png');
        background-size: cover;
        background-position: center;
        background-attachment: fixed;
    }
    
    /* æ´»é¡µç¯æ•ˆæœ */
    .binder-rings {
        position: relative;
        max-width: 900px;
        margin: 0 auto;
        height: 40px;
        z-index: 10;
        pointer-events: none;
        display: flex;
        justify-content: space-between;
        padding: 0 20px;
    }
    
    .ring {
        position: relative;
        top: 10px;
        width: 24px;
        height: 50px;
        border: 4px solid #666;
        border-radius: 50%;
        background: transparent;
        box-shadow: 
            inset 2px 2px 4px rgba(0,0,0,0.3),
            2px 2px 4px rgba(0,0,0,0.4);
        flex-shrink: 0;
    }
    
    /* ç¯çš„ä¸‹åŠéƒ¨åˆ† */
    .ring::before {
        content: '';
        position: absolute;
        top: 50%;
        left: -4px;
        right: -4px;
        bottom: -4px;
        border: 4px solid #666;
        border-top: none;
        border-radius: 0 0 50% 50%;
        background: linear-gradient(to bottom, #888 0%, #666 100%);
        z-index: -1;
    }
    
    /* ç¯çš„ä¸ŠåŠéƒ¨åˆ† */
    .ring::after {
        content: '';
        position: absolute;
        top: -4px;
        left: -4px;
        right: -4px;
        height: 50%;
        border: 4px solid #888;
        border-bottom: none;
        border-radius: 50% 50% 0 0;
        background: linear-gradient(to bottom, #aaa 0%, #888 100%);
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    /* ä¸»å®¹å™¨ */
    .container {
        position: relative;
        max-width: 900px;
        margin: -20px auto 0 auto;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 12px;
        padding: 25px 12px 12px 12px;
        box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        border: 2px solid #000;
        z-index: 5;
    }
    
    h1 {
        text-align: center;
        color: #000;
        margin-bottom: 12px;
        margin-top: 10px;
        font-size: clamp(1em, 3.5vw, 1.8em);
        text-shadow: 1px 1px 2px rgba(255,255,255,0.8);
        word-break: break-word;
    }
    
    .main-layout {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    
    @media (min-width: 968px) {
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
            align-items: start;
        }
    }
    
    .preview-section {
        order: -1;
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    
    @media (min-width: 968px) {
        .preview-section {
            order: 0;
            position: sticky;
            top: 15px;
        }
    }
    
    /* ç”»å¸ƒå®¹å™¨ */
    .canvas-wrapper {
        width: 100%;
        max-width: 400px;
        aspect-ratio: 541 / 648;
        display: flex;
        justify-content: center;
        align-items: center;
        background: #f0f0f0;
        border-radius: 12px;
        padding: 0;
        box-shadow: inset 0 2px 8px rgba(0,0,0,0.1);
        border: 2px solid #000;
        overflow: hidden;
        position: relative;
    }
    
    .canvas-container {
        position: relative;
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    
    canvas {
        max-width: 100%;
        max-height: 100%;
        width: auto !important;
        height: auto !important;
        display: block;
        border-radius: 8px;
    }
    
    .preview-controls {
        width: 100%;
        max-width: 400px;
        margin-top: 12px;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 2px solid #000;
    }
    
    .preview-control-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }
    
    .preview-control-label {
        font-weight: 700;
        color: #000;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .preview-control-value {
        color: #000;
        font-size: 13px;
        font-weight: bold;
    }
    
    .preview-slider {
        width: 100%;
        height: 5px;
        border-radius: 3px;
        background: #ccc;
        outline: none;
        -webkit-appearance: none;
    }
    
    .preview-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #333;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .preview-slider::-moz-range-thumb {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #333;
        cursor: pointer;
        border: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .position-hint {
        font-size: 11px;
        color: #333;
        margin-top: 6px;
        font-style: italic;
        text-align: center;
    }
    
    .controls-section {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 12px;
        border: 2px solid #000;
    }
    
    .control-group {
        margin-bottom: 10px;
    }
    
    .control-group label {
        display: block;
        margin-bottom: 4px;
        font-weight: 700;
        color: #000;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    textarea {
        width: 100%;
        padding: 8px;
        border: 2px solid #000;
        border-radius: 6px;
        font-size: 14px;
        resize: vertical;
        min-height: 60px;
        max-height: 120px;
        transition: all 0.3s;
        font-family: inherit;
        overflow-y: auto;
        background: #fff;
        color: #000;
    }
    
    textarea:focus {
        outline: none;
        border-color: #000;
        box-shadow: 0 0 0 3px rgba(0,0,0,0.1);
    }
    
    select, input[type="number"] {
        width: 100%;
        padding: 6px;
        border: 2px solid #000;
        border-radius: 6px;
        font-size: 13px;
        background: #fff;
        cursor: pointer;
        transition: all 0.3s;
        color: #000;
        height: 36px;
    }
    
    select:focus, input:focus {
        outline: none;
        border-color: #000;
    }
    
    input[type="color"] {
        width: 100%;
        height: 36px;
        padding: 2px;
        border: 2px solid #000;
        border-radius: 6px;
        background: #fff;
        cursor: pointer;
        -webkit-appearance: none;
        appearance: none;
    }
    
    input[type="color"]::-webkit-color-swatch-wrapper {
        padding: 0;
    }
    
    input[type="color"]::-webkit-color-swatch {
        border: none;
        border-radius: 4px;
    }
    
    .file-input-wrapper {
        position: relative;
        overflow: hidden;
        display: inline-block;
        width: 100%;
    }
    
    .file-input-wrapper input[type=file] {
        position: absolute;
        left: -9999px;
    }
    
    .file-input-label {
        display: block;
        padding: 8px;
        background: #333;
        color: #fff;
        text-align: center;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        font-weight: 600;
        font-size: 13px;
        border: 2px solid #333;
        height: 36px;
        line-height: 18px;
    }
    
    .file-input-label:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        background: #555;
    }
    
    .download-btn {
        width: 100%;
        padding: 10px;
        background: #333;
        color: #fff;
        border: 2px solid #333;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-top: 8px;
        height: 44px;
    }
    
    .download-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        background: #555;
    }
    
    .copy-btn {
        width: 100%;
        padding: 10px;
        background: #333;
        color: #fff;
        border: 2px solid #333;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-top: 8px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }
    
    .copy-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        background: #555;
    }
    
    .copy-btn.success {
        background: #2ecc71;
        border-color: #27ae60;
    }
    
    .copy-btn.error {
        background: #e74c3c;
        border-color: #c0392b;
    }
    .welcome-box {
        background: #fff;
        border-left: 3px solid #000;
        padding: 8px 10px;
        border-radius: 4px;
        margin-bottom: 10px;
        font-size: 13px;
        color: #000;
        border: 2px solid #000;
        text-align: center;
        font-weight: 600;
    }
    
    .toggle-wrapper {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px;
        background: #fff;
        border-radius: 6px;
        border: 2px solid #000;
        margin-bottom: 8px;
    }
    
    .toggle-switch {
        position: relative;
        width: 40px;
        height: 22px;
        background: #ccc;
        border-radius: 11px;
        cursor: pointer;
        transition: background 0.3s;
        flex-shrink: 0;
    }
    
    .toggle-switch.active {
        background: #333;
    }
    
    .toggle-switch::after {
        content: '';
        position: absolute;
        width: 18px;
        height: 18px;
        background: #fff;
        border-radius: 50%;
        top: 2px;
        left: 2px;
        transition: transform 0.3s;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .toggle-switch.active::after {
        transform: translateX(18px);
    }
    
    .board-preview {
        margin-top: 6px;
        padding: 6px;
        background: #fff;
        border-radius: 6px;
        border: 2px dashed #000;
        text-align: center;
        font-size: 11px;
        color: #333;
    }
    
    .warning-box {
        background: #fff;
        border-left: 3px solid #000;
        padding: 8px;
        border-radius: 4px;
        margin-bottom: 10px;
        font-size: 12px;
        color: #000;
        display: none;
        border: 2px solid #000;
    }
    
    .warning-box.show {
        display: block;
    }
    
    .loading {
        display: none;
        text-align: center;
        padding: 12px;
        color: #000;
        font-weight: 600;
    }
    
    .spinner {
        display: inline-block;
        width: 18px;
        height: 18px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #333;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 8px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .effect-btn {
        display: block;
        width: 100%;
        padding: 8px;
        background: #333;
        color: #fff;
        border: 2px solid #333;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        margin-top: 0;
        height: 36px;
        line-height: 18px;
    }
    
    .effect-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        background: #555;
    }
    
    .effect-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        padding: 10px;
    }
    
    .effect-modal.show {
        display: flex;
    }
    
    .effect-content {
        background: #fff;
        border-radius: 12px;
        padding: 15px;
        max-width: 450px;
        width: 100%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 15px 40px rgba(0,0,0,0.4);
        border: 2px solid #000;
    }
    
    .effect-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 12px;
        border-bottom: 2px solid #000;
    }
    
    .effect-title {
        font-size: 16px;
        font-weight: 700;
        color: #000;
    }
    
    .effect-close {
        background: none;
        border: none;
        font-size: 22px;
        cursor: pointer;
        color: #000;
        padding: 0;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s;
    }
    
    .effect-close:hover {
        background: #f0f0f0;
        color: #000;
    }
    
    .effect-section {
        margin-bottom: 15px;
    }
    
    .effect-section-title {
        font-size: 13px;
        font-weight: 600;
        color: #000;
        margin-bottom: 8px;
        text-transform: uppercase;
    }
    
    .effect-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 6px;
    }
    
    .effect-item {
        padding: 8px 4px;
        background: #fff;
        border: 2px solid #000;
        border-radius: 6px;
        cursor: pointer;
        font-size: 11px;
        text-align: center;
        transition: all 0.2s;
        color: #000;
    }
    
    .effect-item:hover {
        background: #f0f0f0;
        transform: translateY(-2px);
    }
    
    .effect-item.style-strike { text-decoration: line-through; }
    .effect-item.style-underline { text-decoration: underline; }
    .effect-item.style-bold { font-weight: bold; }
    .effect-item.style-italic { font-style: italic; }
    
    .effect-item.style-magic {
        background: #333;
        color: #fff;
    }
    
    .lineheight-input {
        width: 100%;
        padding: 6px;
        border: 2px solid #000;
        border-radius: 6px;
        font-size: 13px;
        background: #fff;
        transition: all 0.3s;
        color: #000;
        height: 36px;
    }
    
    .lineheight-input:focus {
        outline: none;
        border-color: #000;
    }
    
    /* è¡Œé—´è·å’Œå­—ä½“é¢œè‰²å¹¶æ’ */
    .row-controls {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 10px;
    }
    
    /* å­—ä½“å¤§å°å’Œæ–‡å­—å¯¹é½å¹¶æ’ */
    .text-controls-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        align-items: end;
        margin-top: 8px;
    }
    
    .text-controls-row .control-group {
        margin-bottom: 0;
    }
    
    /* è‡ªå®šä¹‰å›¾ç‰‡æ§åˆ¶åŒºåŸŸ */
    .custom-image-controls {
        background: #e9ecef;
        border-radius: 10px;
        padding: 10px;
        margin-top: 0;
        margin-bottom: 10px;
        color: #000;
        border: 2px solid #000;
    }
    
    .custom-image-controls .control-label {
        font-weight: 600;
        margin-bottom: 6px;
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 4px;
    }
    
    .custom-image-row {
        display: grid;
        grid-template-columns: 1fr auto auto;
        gap: 6px;
        align-items: center;
    }
    
    .custom-image-btn {
        background: #000000;
        color: #fff;
        border: 2px solid #000000;
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        font-size: 12px;
        transition: all 0.3s;
        white-space: nowrap;
        height: 36px;
        line-height: 22px;
    }
    
    .custom-image-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        background: #000000;
    }
    
    .custom-image-btn.remove {
        background: #000000;
        color: #fff;
        border: 2px solid #000000;
        padding: 6px 8px;
    }
    
    .image-align-select {
        padding: 6px;
        border-radius: 6px;
        border: 2px solid #000;
        background: #fff;
        color: #000;
        font-weight: 600;
        cursor: pointer;
        min-width: 80px;
        height: 36px;
        font-size: 12px;
    }
    
    .image-preview-name {
        font-size: 11px;
        color: #000000;
        margin-top: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .zoom-control {
        margin-top: 8px;
        background: rgba(0,0,0,0.1);
        padding: 8px;
        border-radius: 6px;
        border: 1px solid rgba(0,0,0,0.2);
    }
    
    .zoom-control-label {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
        font-size: 12px;
        font-weight: 600;
    }
    
    .zoom-value {
        background: rgba(0,0,0,0.15);
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 11px;
        min-width: 40px;
        text-align: center;
    }
    
    .zoom-slider {
        width: 100%;
        height: 5px;
        border-radius: 3px;
        background: rgba(0,0,0,0.2);
        outline: none;
        -webkit-appearance: none;
    }
    
    .zoom-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #333;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        transition: transform 0.2s;
    }
    
    .zoom-slider::-webkit-slider-thumb:hover {
        transform: scale(1.1);
    }
    
    .zoom-slider::-moz-range-thumb {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #333;
        cursor: pointer;
        border: none;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    
    .zoom-hint {
        font-size: 10px;
        color: #555;
        margin-top: 4px;
        text-align: center;
    }
    
    /* æŒ‰é’®ç»„å¸ƒå±€ */
    .compact-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 10px;
    }
    
    .compact-row .control-group {
        margin-bottom: 0;
    }
    
    /* æŒ‰é’®ç»„æ ·å¼ */
    .action-buttons {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-top: 8px;
    }
    
    .action-buttons .download-btn,
    .action-buttons .copy-btn {
        margin-top: 0;
    }
    
    @media (max-width: 600px) {
        body {
            padding: 45px 8px 8px 8px;
        }
        
        .container {
            padding: 20px 10px 10px 10px;
            margin-top: -15px;
        }
        
        .controls-section {
            padding: 12px;
        }
        
        .effect-grid {
            grid-template-columns: repeat(3, 1fr);
        }
        
        .preview-controls {
            max-width: 100%;
        }
    
        .ring {
            width: 18px;
            height: 40px;
            border-width: 3px;
        }
    
        .ring::before,
        .ring::after {
            border-width: 3px;
        }
    
        .binder-rings {
            padding: 0 10px;
        }
    
        .row-controls {
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
    
        .text-controls-row {
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
    
        .custom-image-row {
            grid-template-columns: 1fr auto auto;
            gap: 6px;
        }
    
        .compact-row {
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
    
        .action-buttons {
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
    
        .control-group {
            margin-bottom: 8px;
        }
    
        h1 {
            font-size: clamp(0.9em, 4vw, 1.5em);
            margin-bottom: 8px;
        }
    }
    
    @media (max-width: 380px) {
        .custom-image-row {
            grid-template-columns: 1fr;
            gap: 6px;
        }
    
        .custom-image-btn.remove {
            width: 100%;
        }
    
        .image-align-select {
            width: 100%;
        }
    
        .compact-row {
            grid-template-columns: 1fr;
        }
    
        .text-controls-row {
            grid-template-columns: 1fr;
        }
    
        .row-controls {
            grid-template-columns: 1fr;
        }
    
        .action-buttons {
            grid-template-columns: 1fr;
        }
    }
  </style>
</head>
<body>
  <!-- æ´»é¡µç¯ -->
  <div class="binder-rings">
    <div class="ring"></div>
    <div class="ring"></div>
    <div class="ring"></div>
    <div class="ring"></div>
    <div class="ring"></div>
    <div class="ring"></div>
    <div class="ring"></div>
    <div class="ring"></div>
  </div>
  <div class="container">
    <h1>ğŸ¨å®‰å®‰ä¸¾ç”»æ¿è¡¨æƒ…åŒ…ç”Ÿæˆå™¨</h1>
    <div class="main-layout">
      <div class="preview-section">
        <div class="canvas-wrapper">
          <div class="canvas-container">
            <canvas id="canvas" width="541" height="648"></canvas>
          </div>
        </div>
        <div class="preview-controls">
          <div class="preview-control-group">
            <div class="preview-control-label">
              <span>å‚ç›´ä½ç½®å¾®è°ƒ</span>
              <span class="preview-control-value" id="previewPosYValue">466</span>
            </div>
            <input type="range" id="posY" min="466" max="620" value="466" class="preview-slider">
            <div class="position-hint" style="margin-top: 5px; text-align: left;">è¶Šå¤§è¶Šé ä¸‹</div>
          </div>
        </div>
      </div>
      <div class="controls-section">
        <div class="welcome-box">ğŸ‘‹ æ¬¢è¿ä½¿ç”¨</div>
        <!-- é€‰æ‹©è¡¨æƒ… -->
        <div class="control-group">
          <label>é€‰æ‹©è¡¨æƒ…</label>
          <select id="emotionSelect" onchange="changeEmotion(this.value)">
            <option value="å¼€å¿ƒ.png">ğŸ˜Š å¼€å¿ƒçš„å¾è¾ˆ</option>
            <option value="é—­çœ¼.png">ğŸ˜Œ é—­çœ¼çš„å¾è¾ˆ</option>
            <option value="ç—…å¨‡.png">ğŸ¥° ç—…å¨‡çš„å¾è¾ˆ</option>
            <option value="å®³æ€•.png">ğŸ˜° å®³æ€•çš„å¾è¾ˆ</option>
            <option value="æ¿€åŠ¨.png">ğŸ¤© æ¿€åŠ¨çš„å¾è¾ˆ</option>
            <option value="æƒŠè®¶.png">ğŸ˜² æƒŠè®¶çš„å¾è¾ˆ</option>
            <option value="å“­æ³£.png">ğŸ˜­ å“­æ³£çš„å¾è¾ˆ</option>
            <option value="è„¸çº¢.png">ğŸ˜³ è„¸çº¢çš„å¾è¾ˆ</option>
            <option value="éš¾å—.png">ğŸ˜£ éš¾å—çš„å¾è¾ˆ</option>
            <option value="ç”Ÿæ°”.png">ğŸ˜  ç”Ÿæ°”çš„å¾è¾ˆ</option>
            <option value="æ— è¡¨æƒ….png">ğŸ˜ æ— è¡¨æƒ…çš„å¾è¾ˆ</option>
            <option value="æ— è¯­.png">ğŸ˜‘ æ— è¯­çš„å¾è¾ˆ</option>
            <option value="custom">â• è‡ªå®šä¹‰å›¾ç‰‡...</option>
          </select>
          <input type="file" id="customEmotionInput" accept="image/*" style="display: none;" onchange="handleCustomEmotion(event)">
        </div>
        <!-- è‡ªå®šä¹‰ç”»æ¿å›¾ç‰‡ -->
        <div class="custom-image-controls" id="customImageControls">
          <div class="control-label"> ğŸ–¼ï¸ è‡ªå®šä¹‰ç”»æ¿å›¾ç‰‡ </div>
          <div class="custom-image-row">
            <button class="custom-image-btn" id="addImageBtn" onclick="document.getElementById('customImageInput').click()"> â• æ·»åŠ å›¾ç‰‡ </button>
            <select class="image-align-select" id="imageAlign" onchange="updateImageAlign()">
              <option value="center">å±…ä¸­</option>
              <option value="left">å·¦å¯¹é½</option>
              <option value="right">å³å¯¹é½</option>
            </select>
            <button class="custom-image-btn remove" id="removeImageBtn" onclick="removeCustomImage()" style="display: none;"> ğŸ—‘ï¸ </button>
          </div>
          <div class="image-preview-name" id="imagePreviewName">æœªæ·»åŠ å›¾ç‰‡</div>
          <div class="zoom-control" id="zoomControl" style="display: none;">
            <div class="zoom-control-label">
              <span>ğŸ” ç¼©æ”¾</span>
              <span class="zoom-value" id="zoomValue">100%</span>
            </div>
            <input type="range" id="zoomSlider" class="zoom-slider" min="20" max="200" value="100" oninput="updateZoom(this.value)">
          </div>
          <input type="file" id="customImageInput" accept="image/*" style="display: none;" onchange="handleCustomImage(event)">
        </div>
        <!-- è‡ªå®šä¹‰æ–‡å­—æ•ˆæœ -->
        <div class="control-group" style="margin-bottom: 10px;">
          <button class="effect-btn" onclick="openEffectModal()">âœ¨ è‡ªå®šä¹‰æ–‡å­—æ•ˆæœ</button>
        </div>
        <div class="warning-box" id="overflowWarning">âš ï¸ æ–‡å­—å†…å®¹å¯èƒ½è¶…å‡ºç”»æ¿ç©ºé—´ï¼Œå»ºè®®ä¿®æ”¹å­—å·å’Œè¡Œé—´è·</div>
        <!-- è¾“å…¥æ–‡å­—å†…å®¹ -->
        <div class="control-group">
          <label>è¾“å…¥æ–‡å­—å†…å®¹ (æ”¯æŒ Emoji)</label>
          <textarea id="textInput" placeholder="åœ¨è¿™é‡Œè¾“å…¥ä½ æƒ³æ˜¾ç¤ºåœ¨ç”»æ¿ä¸Šçš„æ–‡å­—..." oninput="autoResizeTextarea(this)">[é»„è‰²å¼€å§‹]ç¤ºä¾‹æ–‡å­—[é»„è‰²ç»“æŸ]
[æ´—è„‘é­”æ³•å¼€å§‹]ç»™æˆ‘æ¬¡é¦™å’•[æ´—è„‘é­”æ³•ç»“æŸ]
[ä¸‹åˆ’çº¿å¼€å§‹]ç»™æˆ‘æ¬¡é¦™å’•[ä¸‹åˆ’çº¿ç»“æŸ]
[çº¢è‰²å¼€å§‹][åˆ é™¤çº¿å¼€å§‹]å¤šé‡æ•ˆæœ[åˆ é™¤çº¿ç»“æŸ][çº¢è‰²ç»“æŸ]</textarea>
          <!-- å­—ä½“å¤§å°å’Œæ–‡å­—å¯¹é½å¹¶æ’ -->
          <div class="text-controls-row">
            <div class="control-group">
              <label style="margin-bottom: 4px; font-size: 11px;">å­—ä½“å¤§å° (px)</label>
              <input type="number" id="fontSize" value="32" min="12" max="200" style="width: 100%; height: 36px;">
            </div>
            <div class="control-group">
              <label style="margin-bottom: 4px; font-size: 11px;">æ–‡å­—å¯¹é½</label>
              <select id="textAlign" style="width: 100%;">
                <option value="center">å±…ä¸­</option>
                <option value="left">å·¦å¯¹é½</option>
                <option value="right">å³å¯¹é½</option>
              </select>
            </div>
          </div>
        </div>
        <!-- å­—ä½“é€‰æ‹© -->
        <div class="control-group">
          <label>å­—ä½“é€‰æ‹©</label>
          <select id="fontFamily">
            <option value="'Noto Sans SC', 'Noto Color Emoji', sans-serif">é»˜è®¤å­—ä½“ (Noto Sans SC)</option>
            <option value="'ZCOOL KuaiLe', 'Noto Color Emoji', cursive">å¿«ä¹ä½“</option>
            <option value="Arial, 'Noto Color Emoji', sans-serif">Arial</option>
            <option value="'Microsoft YaHei', 'Noto Color Emoji', sans-serif">å¾®è½¯é›…é»‘</option>
            <option value="'SimHei', 'Noto Color Emoji', sans-serif">é»‘ä½“</option>
            <option value="'SimSun', 'Noto Color Emoji', serif">å®‹ä½“</option>
            <option value="'KaiTi', 'Noto Color Emoji', serif">æ¥·ä½“</option>
            <option value="custom">â• è‡ªå®šä¹‰å­—ä½“...</option>
          </select>
          <input type="file" id="customFontInput" accept=".ttf,.otf,.woff,.woff2" style="display: none;">
        </div>
        <!-- è¡Œé—´è·å’Œå­—ä½“é¢œè‰²å¹¶æ’ -->
        <div class="row-controls">
          <div class="control-group" style="margin-bottom: 0;">
            <label>è¡Œé—´è· (å€æ•°)</label>
            <input type="number" id="lineHeight" class="lineheight-input" value="1.2" min="1.0" max="3.0" step="0.1">
          </div>
          <div class="control-group" style="margin-bottom: 0;">
            <label>é»˜è®¤å­—ä½“é¢œè‰²</label>
            <input type="color" id="fontColor" value="#2c3e50">
          </div>
        </div>
        <div class="loading" id="loading"><span class="spinner"></span>æ­£åœ¨ç”Ÿæˆå›¾ç‰‡...</div>
        <!-- ä¸‹è½½å’Œå¤åˆ¶æŒ‰é’®å¹¶æ’ -->
        <div class="action-buttons">
          <button class="download-btn" onclick="downloadImage()">â¬‡ï¸ ä¿å­˜å›¾ç‰‡</button>
          <button class="copy-btn" id="copyBtn" onclick="copyToClipboard()">ğŸ“‹ ä¿å­˜åˆ°ç²˜è´´æ¿</button>
        </div>
        <!-- ç§»åŠ¨ç«¯æç¤º -->
        <div id="mobileWarning" style="display: none; margin-top: 10px; padding: 10px; background: #fff3f3; border: 2px solid #e74c3c; border-radius: 8px; color: #c0392b; font-size: 12px; line-height: 1.6;">
          âš ï¸ ä½ å¥½åƒåœ¨ä½¿ç”¨æ‰‹æœº/ç§»åŠ¨å¹³å°å–µ<br>
          å¯¹äºæ‰‹æœº/ç§»åŠ¨å¹³å°ï¼Œæœ‰äº›è½¯ä»¶æ˜¯æ— æ³•æ”¯æŒä»ç²˜è´´æ¿ç²˜è´´å›¾ç‰‡çš„ï¼Œå°±æ¯”å¦‚æ‰‹æœºQQå°±ä¸è¡Œï¼Œä½†æ˜¯æ‰‹æœºå¾®ä¿¡å°±å¯ä»¥ï¼Œè½¯ä»¶å®˜æ–¹ä¸æ”¯æŒæˆ‘ä¹Ÿæ²¡åŠæ³•ï¼Œå¯¹äºä¸æ”¯æŒçš„æ‰‹æœºè½¯ä»¶ï¼Œä½ å¯ä»¥ä¿å­˜å›¾ç‰‡æ‰‹åŠ¨å‘é€ï¼Œç”µè„‘çš„è½¯ä»¶éƒ½æ”¯æŒ
        </div>
      </div>
    </div>
  </div>
  <div class="effect-modal" id="effectModal" onclick="closeEffectModal(event)">
    <div class="effect-content" onclick="event.stopPropagation()">
      <div class="effect-header">
        <span class="effect-title">âœ¨ è‡ªå®šä¹‰æ–‡å­—æ•ˆæœ</span>
        <button class="effect-close" onclick="closeEffectModal()">Ã—</button>
      </div>
      <div class="effect-section" style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-top: 15px;">
        <div class="effect-section-title">ğŸ’¡ ä½¿ç”¨è¯´æ˜</div>
        <div style="font-size: 12px; color: #666; line-height: 1.8;">
          <p style="margin-bottom: 8px;">ç‚¹å‡»ä¸‹æ–¹æ•ˆæœæŒ‰é’®æ’å…¥æ ‡è®°ï¼Œå°±æ¯”å¦‚ï¼š</p>
          <div style="background: #fff; border: 1px solid #ddd; border-radius: 4px; padding: 8px; margin-bottom: 8px; font-family: monospace;">
            <div>[çº¢è‰²å¼€å§‹]<span style="color: #e74c3c;">è¿™é‡Œçš„æ–‡å­—ä¼šæ˜¾ç¤ºæˆçº¢è‰²</span>[çº¢è‰²ç»“æŸ]</div>
          </div>
          <p style="margin-bottom: 8px;">æ”¯æŒæ•ˆæœå åŠ ï¼š</p>
          <div style="background: #fff; border: 1px solid #ddd; border-radius: 4px; padding: 8px; font-family: monospace;">
            <div>[çº¢è‰²å¼€å§‹][åˆ é™¤çº¿å¼€å§‹]<span style="color: #e74c3c; text-decoration: line-through;">è¿™é‡Œçš„æ–‡å­—ä¼šæ˜¾ç¤ºæˆçº¢è‰²ï¼Œå¹¶ä¸”å¸¦æœ‰åˆ é™¤çº¿</span>[åˆ é™¤çº¿ç»“æŸ][çº¢è‰²ç»“æŸ]</div>
          </div>
        </div>
      </div>
      <div class="effect-section">
        <div class="effect-section-title">ğŸ¨ é¢œè‰²æ•ˆæœ</div>
        <div class="effect-grid">
          <div class="effect-item color-red" onclick="insertEffect('[çº¢è‰²å¼€å§‹]', '[çº¢è‰²ç»“æŸ]')">çº¢è‰²</div>
          <div class="effect-item color-orange" onclick="insertEffect('[æ©™è‰²å¼€å§‹]', '[æ©™è‰²ç»“æŸ]')">æ©™è‰²</div>
          <div class="effect-item color-yellow" onclick="insertEffect('[é»„è‰²å¼€å§‹]', '[é»„è‰²ç»“æŸ]')">é»„è‰²</div>
          <div class="effect-item color-green" onclick="insertEffect('[ç»¿è‰²å¼€å§‹]', '[ç»¿è‰²ç»“æŸ]')">ç»¿è‰²</div>
          <div class="effect-item color-cyan" onclick="insertEffect('[é’è‰²å¼€å§‹]', '[é’è‰²ç»“æŸ]')">é’è‰²</div>
          <div class="effect-item color-blue" onclick="insertEffect('[è“è‰²å¼€å§‹]', '[è“è‰²ç»“æŸ]')">è“è‰²</div>
          <div class="effect-item color-purple" onclick="insertEffect('[ç´«è‰²å¼€å§‹]', '[ç´«è‰²ç»“æŸ]')">ç´«è‰²</div>
          <div class="effect-item color-pink" onclick="insertEffect('[ç²‰è‰²å¼€å§‹]', '[ç²‰è‰²ç»“æŸ]')">ç²‰è‰²</div>
          <div class="effect-item color-gray" onclick="insertEffect('[ç°è‰²å¼€å§‹]', '[ç°è‰²ç»“æŸ]')">ç°è‰²</div>
          <div class="effect-item color-black" onclick="insertEffect('[é»‘è‰²å¼€å§‹]', '[é»‘è‰²ç»“æŸ]')">é»‘è‰²</div>
          <div class="effect-item color-white" onclick="insertEffect('[ç™½è‰²å¼€å§‹]', '[ç™½è‰²ç»“æŸ]')">ç™½è‰²</div>
          <div class="effect-item color-brown" onclick="insertEffect('[æ£•è‰²å¼€å§‹]', '[æ£•è‰²ç»“æŸ]')">æ£•è‰²</div>
        </div>
      </div>
      <div class="effect-section">
        <div class="effect-section-title">âœï¸ æ–‡å­—æ ·å¼</div>
        <div class="effect-grid">
          <div class="effect-item style-strike" onclick="insertEffect('[åˆ é™¤çº¿å¼€å§‹]', '[åˆ é™¤çº¿ç»“æŸ]')">åˆ é™¤çº¿</div>
          <div class="effect-item style-underline" onclick="insertEffect('[ä¸‹åˆ’çº¿å¼€å§‹]', '[ä¸‹åˆ’çº¿ç»“æŸ]')">ä¸‹åˆ’çº¿</div>
          <div class="effect-item style-italic" onclick="insertEffect('[æ–œä½“å¼€å§‹]', '[æ–œä½“ç»“æŸ]')">æ–œä½“</div>
          <div class="effect-item style-bold" onclick="insertEffect('[ç²—ä½“å¼€å§‹]', '[ç²—ä½“ç»“æŸ]')">ç²—ä½“</div>
          <div class="effect-item style-magic" onclick="insertEffect('[æ´—è„‘é­”æ³•å¼€å§‹]', '[æ´—è„‘é­”æ³•ç»“æŸ]')">æ´—è„‘é­”æ³•</div>
        </div>
      </div>
    </div>
  </div>
  <div style="text-align: center; padding: 15px; color: #fff; font-size: 12px; line-height: 1.8; margin-top: 10px; text-shadow: 1px 1px 2px rgba(0,0,0,0.8);"> æ­¤ç½‘é¡µç”±<a href="https://xiau.net" target="_blank" style="color: #fff; text-decoration: underline; font-weight: bold;">å¤çš„åšå®¢</a>å¼€å‘ï¼Œæ„Ÿè°¢é¡¹ç›®ï¼š<a
      href="https://github.com/MarkCup-Official/Anan-s-Sketchbook-Chat-Box" target="_blank" style="color: #fff; text-decoration: underline;">Anan-s-Sketchbook-Chat-Box</a><br> ç½‘é¡µç‰ˆæœ¬ V1.1ï¼ŒèƒŒæ™¯æ¥è‡ªæ¸¸æˆï¼šæ¢¦ç¯èŠ± </div>
  <script>
    // ============================================
    // å…¨å±€å˜é‡å®šä¹‰
    // ============================================
    
    /*ä¸»ç”»å¸ƒå…ƒç´ */
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const images = { base: new Image(), hand: new Image() };
    let customImageData = null;
    let customFontName = '';
    let currentEmotion = 'å¼€å¿ƒ.png';
    let isCustomEmotion = false;
    let isDrawing = false;
    
    /**
     * é¢œè‰²åç§°åˆ°åå…­è¿›åˆ¶çš„æ˜ å°„è¡¨
     * ç”¨äºè§£æ [é¢œè‰²å¼€å§‹] æ ‡ç­¾
     */
    const colorMap = {
        'çº¢è‰²': '#e74c3c', 'æ©™è‰²': '#e67e22', 'é»„è‰²': '#f1c40f', 'ç»¿è‰²': '#2ecc71',
        'é’è‰²': '#1abc9c', 'è“è‰²': '#3498db', 'ç´«è‰²': '#9b59b6', 'ç²‰è‰²': '#fd79a8',
        'ç°è‰²': '#7f8c8d', 'é»‘è‰²': '#2c3e50', 'ç™½è‰²': '#ecf0f1', 'æ£•è‰²': '#8b4513'
    };
    
    /**
     * ç”»æ¿åŒºåŸŸåæ ‡å®šä¹‰
     * ç™½è‰²ç”»æ¿åœ¨ç”»å¸ƒä¸­çš„ä½ç½®å’Œå°ºå¯¸
     */
    const canvasBoard = {
        left: 93,      // ç”»æ¿å·¦è¾¹ç•Œ
        right: 425,    // ç”»æ¿å³è¾¹ç•Œ
        top: 430,      // ç”»æ¿ä¸Šè¾¹ç•Œ
        bottom: 665,   // ç”»æ¿ä¸‹è¾¹ç•Œ
        get width() { return this.right - this.left; },
        get height() { return this.bottom - this.top; }
    };
    
    // ============================================
    // å›¾ç‰‡åŠ è½½ä¸è¡¨æƒ…åˆ‡æ¢
    // ============================================
    
    /**
     * åˆå§‹åŒ–é»˜è®¤å›¾ç‰‡èµ„æº
     * åŠ è½½å¼€å¿ƒè¡¨æƒ…å’Œæ‰‹éƒ¨ overlayï¼Œç­‰å¾…ä¸¤å¼ éƒ½åŠ è½½å®Œæˆåç»˜åˆ¶
     */
    function initImages() {
        let loaded = 0;
        const onLoad = () => { loaded++; if (loaded >= 2) drawCanvas(); };
        images.base.onload = onLoad;
        images.hand.onload = onLoad;
        images.base.onerror = onLoad;
        images.hand.onerror = onLoad;
        images.base.src = 'anans/å¼€å¿ƒ.png';
        images.hand.src = 'anans/AnAn2.png';
    }
    
    /**
     * åˆ‡æ¢è¡¨æƒ…å›¾ç‰‡
     */
    function changeEmotion(filename) {
        // å¤„ç†è‡ªå®šä¹‰è¡¨æƒ…é€‰æ‹©
        if (filename === 'custom') {
            document.getElementById('customEmotionInput').click();
            // æ¢å¤selectæ˜¾ç¤ºä¸ºå½“å‰å®é™…ä½¿ç”¨çš„è¡¨æƒ…
            document.getElementById('emotionSelect').value = isCustomEmotion ? 'custom' : currentEmotion;
            return;
        }
        
        isCustomEmotion = false;
        currentEmotion = filename;
        const img = new Image();
        img.onload = () => { images.base = img; drawCanvas(); };
        img.onerror = drawCanvas;
        img.src = 'anans/' + filename;
    }
    
    /**
     * å¤„ç†ç”¨æˆ·ä¸Šä¼ çš„è‡ªå®šä¹‰è¡¨æƒ…å›¾ç‰‡
     */
    function handleCustomEmotion(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (ev) => {
            const img = new Image();
            img.onload = () => {
                // è®¾ç½®è‡ªå®šä¹‰è¡¨æƒ…å›¾ç‰‡
                images.base = img;
                isCustomEmotion = true;
                
                // åœ¨selectä¸­æ·»åŠ /æ›´æ–°è‡ªå®šä¹‰é€‰é¡¹
                const select = document.getElementById('emotionSelect');
                select.querySelector('option[value^="custom_"]')?.remove();
                
                const opt = document.createElement('option');
                opt.value = 'custom';
                // æˆªæ–­é•¿æ–‡ä»¶åæ˜¾ç¤º
                opt.text = 'ğŸ“· ' + file.name.substring(0, 20) + (file.name.length > 20 ? '...' : '');
                opt.selected = true;
                select.insertBefore(opt, select.lastChild);
                
                drawCanvas();
            };
            img.onerror = () => {
                alert('å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œè¯·å°è¯•å…¶ä»–å›¾ç‰‡');
                document.getElementById('emotionSelect').value = isCustomEmotion ? 'custom' : currentEmotion;
            };
            img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
    }
    
    // ============================================
    // è‡ªå®šä¹‰ç”»æ¿å›¾ç‰‡åŠŸèƒ½
    // ============================================
    
    /**
     * å¤„ç†ç”¨æˆ·ä¸Šä¼ çš„ç”»æ¿å›¾ç‰‡
     */
    function handleCustomImage(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (ev) => {
            const img = new Image();
            img.onload = () => {
                // å­˜å‚¨ç”»æ¿å›¾ç‰‡æ•°æ®
                customImageData = {
                    image: img,
                    name: file.name,
                    align: document.getElementById('imageAlign').value,
                    zoom: 100
                };
                // æ›´æ–°UIæ˜¾ç¤º
                document.getElementById('imagePreviewName').textContent = file.name;
                document.getElementById('removeImageBtn').style.display = 'inline-block';
                document.getElementById('zoomControl').style.display = 'block';
                drawCanvas();
            };
            img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
    }
    
    /** ç§»é™¤è‡ªå®šä¹‰ç”»æ¿å›¾ç‰‡ */
    function removeCustomImage() {
        customImageData = null;
        document.getElementById('customImageInput').value = '';
        document.getElementById('imagePreviewName').textContent = 'æœªæ·»åŠ å›¾ç‰‡';
        document.getElementById('removeImageBtn').style.display = 'none';
        document.getElementById('zoomControl').style.display = 'none';
        drawCanvas();
    }
    
    /** æ›´æ–°ç”»æ¿å›¾ç‰‡å¯¹é½æ–¹å¼ */
    function updateImageAlign() {
        if (customImageData) {
            customImageData.align = document.getElementById('imageAlign').value;
            drawCanvas();
        }
    }
    
    /**
     * æ›´æ–°ç”»æ¿å›¾ç‰‡ç¼©æ”¾æ¯”ä¾‹
     */
    function updateZoom(value) {
        if (customImageData) {
            customImageData.zoom = parseInt(value);
            document.getElementById('zoomValue').textContent = value + '%';
            drawCanvas();
        }
    }
    
    /**
     * è®¡ç®—ç”»æ¿å›¾ç‰‡åœ¨ç”»å¸ƒä¸­çš„ç»˜åˆ¶ä½ç½®å’Œå°ºå¯¸
     */
    function calculateImageLayout() {
        if (!customImageData) return null;
        
        const maxW = canvasBoard.width - 20;
        const maxH = canvasBoard.height - 20;
        const img = customImageData.image;
        const zoom = customImageData.zoom || 100;
        
        // è®¡ç®—è‡ªé€‚åº”ç¼©æ”¾æ¯”ä¾‹ï¼Œä¿æŒå®½é«˜æ¯”ï¼Œä¸è¶…è¿‡ç”»æ¿åŒºåŸŸ
        const scale = Math.min(maxW / img.width, maxH / img.height, 1) * (zoom / 100);
        const w = img.width * scale;
        const h = img.height * scale;
        
        // æ ¹æ®å¯¹é½æ–¹å¼è®¡ç®—xåæ ‡
        let x = canvasBoard.left + 10;
        if (customImageData.align === 'center') {
            x = canvasBoard.left + (canvasBoard.width - w) / 2;
        } else if (customImageData.align === 'right') {
            x = canvasBoard.right - 10 - w;
        }
        
        // bottom + 35 æ˜¯å›¾ç‰‡åº•éƒ¨åˆ°æ–‡å­—é¡¶éƒ¨çš„é—´è·ï¼Œé˜²æ­¢é‡å 
        return {
            x: x,
            y: canvasBoard.top + 10,
            width: w,
            height: h,
            bottom: canvasBoard.top + 10 + h + 35,
            scale: scale
        };
    }
    
    // ============================================
    // æ–‡å­—æ•ˆæœå¤„ç†
    // ============================================
    
    /** è‡ªåŠ¨è°ƒæ•´textareaé«˜åº¦ */
    function autoResizeTextarea(t) {
        t.style.height = 'auto';
        t.style.height = Math.min(Math.max(t.scrollHeight, 60), 120) + 'px';
        drawCanvas();
    }
    
    /** æ‰“å¼€/å…³é—­æ•ˆæœé€‰æ‹©å¼¹çª— */
    function openEffectModal() { document.getElementById('effectModal').classList.add('show'); }
    function closeEffectModal(e) { 
        if (!e || e.target.id === 'effectModal') document.getElementById('effectModal').classList.remove('show'); 
    }
    
    /**
     * åœ¨textareaå…‰æ ‡ä½ç½®æ’å…¥æ•ˆæœæ ‡ç­¾
     */
    function insertEffect(start, end) {
        const t = document.getElementById('textInput');
        const s = t.selectionStart, e = t.selectionEnd, v = t.value;
        t.value = v.substring(0, s) + start + v.substring(s, e) + end + v.substring(e);
        t.focus();
        t.setSelectionRange(s + start.length, s + start.length);
        autoResizeTextarea(t);
        closeEffectModal();
    }
    
    /**
     * é¢„å¤„ç†æ´—è„‘é­”æ³•æ•ˆæœæ·»åŠ ã€Œã€åŒ…è£¹
     */
    function preprocessMagic(t) { 
        return t.replace(/\[æ´—è„‘é­”æ³•å¼€å§‹\]([\s\S]*?)\[æ´—è„‘é­”æ³•ç»“æŸ\]/g, '[æ´—è„‘é­”æ³•å¼€å§‹]ã€Œ$1ã€[æ´—è„‘é­”æ³•ç»“æŸ]'); 
    }
    
    /**
     * è§£æå¸¦æ ·å¼æ ‡ç­¾çš„æ–‡æœ¬ï¼Œç”Ÿæˆå­—ç¬¦çº§æ ·å¼æ•°æ®
     */
    function parseStyledText(t) {
        t = preprocessMagic(t);
        
        // æå–æ‰€æœ‰æ ‡ç­¾
        const tagRe = /\[(çº¢è‰²|æ©™è‰²|é»„è‰²|ç»¿è‰²|é’è‰²|è“è‰²|ç´«è‰²|ç²‰è‰²|ç°è‰²|é»‘è‰²|ç™½è‰²|æ£•è‰²|åˆ é™¤çº¿|ä¸‹åˆ’çº¿|æ–œä½“|ç²—ä½“|æ´—è„‘é­”æ³•)(å¼€å§‹|ç»“æŸ)\]/g;
        const tags = [];
        let m;
        while ((m = tagRe.exec(t)) !== null) {
            tags.push({ index: m.index, name: m[1], type: m[2], len: m[0].length });
        }
        tags.sort((a, b) => a.index - b.index);
        
        // æ„å»ºæ ·å¼åŒºé—´
        const intervals = [];
        const styles = { color: null, strike: false, underline: false, italic: false, bold: false };
        const stack = [];
        let pos = 0;
        
        for (const tag of tags) {
            if (tag.index > pos) intervals.push({ start: pos, end: tag.index, styles: { ...styles } });
            
            if (tag.type === 'å¼€å§‹') {
                // ä¿å­˜å½“å‰çŠ¶æ€åˆ°æ ˆ
                stack.push({ name: tag.name, styles: { ...styles } });
                // åº”ç”¨æ–°æ ·å¼
                if (colorMap[tag.name]) styles.color = colorMap[tag.name];
                else if (tag.name === 'åˆ é™¤çº¿') styles.strike = true;
                else if (tag.name === 'ä¸‹åˆ’çº¿') styles.underline = true;
                else if (tag.name === 'æ–œä½“') styles.italic = true;
                else if (tag.name === 'ç²—ä½“') styles.bold = true;
                else if (tag.name === 'æ´—è„‘é­”æ³•') styles.color = '#9b59b6';
            } else {
                // ç»“æŸæ ‡ç­¾ï¼šæ¢å¤ä¹‹å‰çš„çŠ¶æ€
                const i = stack.findIndex(x => x.name === tag.name);
                if (i !== -1) { Object.assign(styles, stack[i].styles); stack.splice(i, 1); }
            }
            pos = tag.index + tag.len;
        }
        if (pos < t.length) intervals.push({ start: pos, end: t.length, styles: { ...styles } });
        
        // å±•å¼€ä¸ºå­—ç¬¦æ•°ç»„
        const result = [];
        for (const int of intervals) {
            for (const c of Array.from(t.substring(int.start, int.end))) {
                result.push({ char: c, ...int.styles });
            }
        }
        return result;
    }
    
    // ============================================
    // æ–‡æœ¬æ¸²æŸ“
    // ============================================
    /***/
    function renderTextLines(chars, maxW, fontSize, fontFamily, defaultColor, align, startY, lineHeight, imgBottom) {
        // æ–‡å­—èµ·å§‹Yåæ ‡ï¼šå¦‚æœæœ‰ç”»æ¿å›¾ç‰‡ï¼Œä»å›¾ç‰‡åº•éƒ¨å¼€å§‹ï¼›å¦åˆ™ä»startYå¼€å§‹
        const textY = (imgBottom || startY) + 10;
        
        // é¢„è®¡ç®—æ¯ä¸ªå­—ç¬¦çš„å­—ä½“å’Œå®½åº¦
        const processed = chars.map(c => {
            const style = c.italic ? 'italic' : 'normal';
            const weight = c.bold ? 'bold' : 'normal';
            ctx.font = `${style} ${weight} ${fontSize}px ${fontFamily}`;
            return { ...c, font: ctx.font, width: ctx.measureText(c.char).width };
        });
        
        // åˆ†è¡Œå¤„ç†
        const lines = [];
        let line = [], lineW = 0;
        for (const c of processed) {
            if (c.char === '\n') {
                if (line.length) { lines.push(line); line = []; lineW = 0; }
                continue;
            }
            // è‡ªåŠ¨æ¢è¡Œ
            if (lineW + c.width > maxW && line.length) {
                lines.push(line);
                line = [c];
                lineW = c.width;
            } else {
                line.push(c);
                lineW += c.width;
            }
        }
        if (line.length) lines.push(line);
        if (!lines.length) lines.push([]);
        
        // è®¡ç®—åŸºçº¿ä½ç½®å‚æ•°
        ctx.font = `normal ${fontSize}px ${fontFamily}`;
        const ascent = ctx.measureText('M').actualBoundingBoxAscent || fontSize * 0.8;
        const descent = ctx.measureText('M').actualBoundingBoxDescent || fontSize * 0.2;
        const textH = ascent + descent;
        
        // é€è¡Œç»˜åˆ¶
        for (let i = 0; i < lines.length; i++) {
            const lineY = textY + i * lineHeight;
            if (lineY > canvasBoard.bottom + 20) break; // è¶…å‡ºç”»æ¿åº•éƒ¨åœæ­¢ç»˜åˆ¶
            
            const lineW = lines[i].reduce((a, c) => a + c.width, 0);
            // è®¡ç®—è¡Œèµ·å§‹Xåæ ‡
            let x = canvasBoard.left;
            if (align === 'center') x = canvasBoard.left + (canvasBoard.width - lineW) / 2;
            else if (align === 'right') x = canvasBoard.right - lineW;
            
            // æ”¶é›†åˆ é™¤çº¿å’Œä¸‹åˆ’çº¿çš„è¿ç»­åŒºé—´
            const strikes = [], underlines = [];
            let curX = x, strikeStart = null, underStart = null;
            for (let j = 0; j < lines[i].length; j++) {
                const c = lines[i][j];
                if (c.strike && strikeStart === null) strikeStart = curX;
                else if (!c.strike && strikeStart !== null) { 
                    strikes.push({ s: strikeStart, e: curX, color: lines[i][j-1].color }); 
                    strikeStart = null; 
                }
                if (c.underline && underStart === null) underStart = curX;
                else if (!c.underline && underStart !== null) { 
                    underlines.push({ s: underStart, e: curX, color: lines[i][j-1].color }); 
                    underStart = null; 
                }
                curX += c.width;
            }
            // å¤„ç†è¡Œå°¾æœªé—­åˆçš„æ ·å¼
            if (strikeStart !== null) strikes.push({ s: strikeStart, e: curX, color: lines[i][lines[i].length-1].color });
            if (underStart !== null) underlines.push({ s: underStart, e: curX, color: lines[i][lines[i].length-1].color });
            
            // ç»˜åˆ¶æ–‡å­—
            curX = x;
            for (const c of lines[i]) {
                ctx.font = c.font;
                ctx.fillStyle = c.color || defaultColor;
                ctx.fillText(c.char, curX, lineY);
                curX += c.width;
            }
            
            // ç»˜åˆ¶åˆ é™¤çº¿å’Œä¸‹åˆ’çº¿
            ctx.save();
            ctx.lineWidth = Math.max(1, fontSize * 0.08);
            const strikeY = lineY - (ascent - textH * 0.5);
            for (const s of strikes) {
                ctx.beginPath();
                ctx.strokeStyle = s.color || defaultColor;
                ctx.moveTo(s.s, strikeY);
                ctx.lineTo(s.e, strikeY);
                ctx.stroke();
            }
            const underY = lineY + descent * 0.8;
            for (const u of underlines) {
                ctx.beginPath();
                ctx.strokeStyle = u.color || defaultColor;
                ctx.moveTo(u.s, underY);
                ctx.lineTo(u.e, underY);
                ctx.stroke();
            }
            ctx.restore();
        }
        return lines.length;
    }
    
    // ============================================
    // ä¸»ç»˜åˆ¶é€»è¾‘
    // ============================================
    
    /**
     * ä¸»ç»˜åˆ¶å‡½æ•°
     */
    function drawCanvas() {
        if (isDrawing) return;
        isDrawing = true;
        
        // ç­‰å¾…åº•å›¾åŠ è½½å®Œæˆ
        if ((!images.base.complete || !images.base.naturalWidth) && images.base.src) {
            isDrawing = false;
            setTimeout(drawCanvas, 50);
            return;
        }
        
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // 1. ç»˜åˆ¶è¡¨æƒ…åº•å›¾
        if (images.base.complete && images.base.naturalWidth) {
            ctx.drawImage(images.base, 0, 0, canvas.width, canvas.height);
        } else {
            // åŠ è½½ä¸­å ä½
            ctx.fillStyle = '#f5f5f5';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#999';
            ctx.textAlign = 'center';
            ctx.fillText('åŠ è½½ä¸­...', canvas.width/2, canvas.height/2);
        }
        
        // 2. ç»˜åˆ¶è‡ªå®šä¹‰ç”»æ¿å›¾ç‰‡ï¼ˆå¦‚æœæœ‰ï¼‰
        let imgBottom = null;
        if (customImageData) {
            const layout = calculateImageLayout();
            if (layout) {
                ctx.drawImage(customImageData.image, layout.x, layout.y, layout.width, layout.height);
                imgBottom = layout.bottom;
            }
        }
        
        // 3. è·å–ç»˜åˆ¶å‚æ•°
        const fontSize = parseInt(document.getElementById('fontSize').value) || 32;
        let fontFamily = document.getElementById('fontFamily').value;
        if (fontFamily === 'custom') fontFamily = "'Noto Sans SC', 'Noto Color Emoji', sans-serif";
        const color = document.getElementById('fontColor').value;
        const align = document.getElementById('textAlign').value;
        const startY = parseInt(document.getElementById('posY').value) || 466;
        const lineHeight = fontSize * (parseFloat(document.getElementById('lineHeight').value) || 1.2);
        
        // 4. è§£æå¹¶ç»˜åˆ¶æ–‡å­—
        const text = document.getElementById('textInput').value || '';
        const chars = parseStyledText(text);
        const maxW = canvasBoard.width - 20;
        const lines = renderTextLines(chars, maxW, fontSize, fontFamily, color, align, startY, lineHeight, imgBottom);
        
        // 5. æ£€æŸ¥æ–‡å­—æ˜¯å¦è¶…å‡ºç”»æ¿
        const endY = (imgBottom || startY) + lines * lineHeight;
        document.getElementById('overflowWarning').classList.toggle('show', endY > 650);
        
        if (!customImageData && !isCustomEmotion && images.hand.complete && images.hand.naturalWidth) {
           ctx.drawImage(images.hand, 0, 0, canvas.width, canvas.height);
         }
        
        isDrawing = false;
    }
    
    // ============================================
    // ä¸‹è½½åŠŸèƒ½
    // ============================================
    
    /** ç”Ÿæˆå¹¶ä¸‹è½½åˆæˆåçš„å›¾ç‰‡ */
    function downloadImage() {
        document.getElementById('loading').style.display = 'block';
        setTimeout(() => {
            const link = document.createElement('a');
            link.download = '[anan.xia.kim]å¤ç›®å®‰å®‰_' + currentEmotion.replace('.png', '') + '_' + Date.now() + '.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
            document.getElementById('loading').style.display = 'none';
        }, 100);
    }
    
    // ============================================
    // å¤åˆ¶åˆ°å‰ªè´´æ¿åŠŸèƒ½
    // ============================================
    
    /**
     * å°†Canvaså†…å®¹å¤åˆ¶åˆ°ç³»ç»Ÿå‰ªè´´æ¿
     * ä½¿ç”¨Clipboard APIå†™å…¥PNGæ ¼å¼çš„å›¾ç‰‡æ•°æ®
     */
    async function copyToClipboard() {
        const copyBtn = document.getElementById('copyBtn');
        const originalText = copyBtn.innerHTML;
        
        // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒClipboard API
        if (!navigator.clipboard || !navigator.clipboard.write) {
            showCopyFeedback(copyBtn, 'error', 'âŒ æµè§ˆå™¨ä¸æ”¯æŒ');
            return;
        }
    
        try {
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            copyBtn.disabled = true;
            copyBtn.innerHTML = '<span class="spinner" style="width: 14px; height: 14px; border-width: 2px; margin: 0;"></span> å¤åˆ¶ä¸­...';
    
            // å°†Canvasè½¬æ¢ä¸ºBlobï¼ˆPNGæ ¼å¼ï¼‰
            const blob = await new Promise((resolve) => {
                canvas.toBlob(resolve, 'image/png');
            });
    
            if (!blob) {
                throw new Error('Canvasè½¬æ¢å¤±è´¥');
            }
    
            // åˆ›å»ºClipboardItemå¹¶å†™å…¥å‰ªè´´æ¿
            const item = new ClipboardItem({ 'image/png': blob });
            await navigator.clipboard.write([item]);
    
            // æ˜¾ç¤ºæˆåŠŸåé¦ˆ
            showCopyFeedback(copyBtn, 'success', 'âœ… å·²å¤åˆ¶!å¯ç›´æ¥ç²˜è´´åˆ°èŠå¤©è½¯ä»¶');
            
        } catch (err) {
            console.error('å¤åˆ¶å¤±è´¥:', err);
            // åŒºåˆ†æƒé™é”™è¯¯å’Œå…¶ä»–é”™è¯¯
            if (err.name === 'NotAllowedError' || err.name === 'SecurityError') {
                showCopyFeedback(copyBtn, 'error', 'âŒ éœ€è¦æƒé™');
            } else {
                showCopyFeedback(copyBtn, 'error', 'âŒ å¤åˆ¶å¤±è´¥');
            }
        } finally {
            copyBtn.disabled = false;
            // 2ç§’åæ¢å¤åŸå§‹çŠ¶æ€
            setTimeout(() => {
                copyBtn.classList.remove('success', 'error');
                copyBtn.innerHTML = originalText;
            }, 2000);
        }
    }
    
    /*
     * æ˜¾ç¤ºå¤åˆ¶æ“ä½œçš„è§†è§‰åé¦ˆ
     */
    function showCopyFeedback(btn, type, text) {
        btn.classList.remove('success', 'error');
        btn.classList.add(type);
        btn.innerHTML = text;
    }
    
    // ============================================
    // äº‹ä»¶ç»‘å®š
    // ============================================
    
    // æ–‡æœ¬è¾“å…¥
    document.getElementById('textInput').addEventListener('input', function() { autoResizeTextarea(this); });
    
    // å­—ä½“å’Œæ ·å¼æ§åˆ¶
    document.getElementById('fontFamily').addEventListener('change', drawCanvas);
    document.getElementById('fontSize').addEventListener('input', drawCanvas);
    document.getElementById('fontColor').addEventListener('input', drawCanvas);
    document.getElementById('textAlign').addEventListener('change', drawCanvas);
    document.getElementById('posY').addEventListener('input', function() { 
        document.getElementById('previewPosYValue').textContent = this.value; 
        drawCanvas(); 
    });
    document.getElementById('lineHeight').addEventListener('input', drawCanvas);
    
    // è‡ªå®šä¹‰å­—ä½“ä¸Šä¼ 
    document.getElementById('fontFamily').addEventListener('change', function(e) {
        if (e.target.value === 'custom') document.getElementById('customFontInput').click();
    });
    document.getElementById('customFontInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            const name = 'CustomFont_' + Date.now();
            new FontFace(name, ev.target.result).load().then((f) => {
                document.fonts.add(f);
                const opt = document.createElement('option');
                opt.value = name + ", 'Noto Color Emoji', sans-serif";
                opt.text = 'ğŸ“ ' + file.name;
                opt.selected = true;
                this.insertBefore(opt, this.lastChild);
                drawCanvas();
            }).catch(() => { 
                alert('å­—ä½“åŠ è½½å¤±è´¥'); 
                this.value = "'Noto Sans SC', 'Noto Color Emoji', sans-serif"; 
            });
        };
        reader.readAsArrayBuffer(file);
    });
    
    // ============================================
    // åˆå§‹åŒ–
    // ============================================
    
    window.onload = () => { 
        initImages(); 
        autoResizeTextarea(document.getElementById('textInput'));
        
        // æ£€æµ‹ç§»åŠ¨å¹³å°æ˜¾ç¤ºæç¤º
        if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
            document.getElementById('mobileWarning').style.display = 'block';
        }
    };
  </script>
</body>
</html>
